/*! A_runTrackr 2018-04-08 */

!function i(r,s,l){function u(t,e){if(!s[t]){if(!r[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);var o=new Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}var a=s[t]={exports:{}};r[t][0].call(a.exports,function(e){return u(r[t][1][e]||e)},a,a.exports,i,r,s,l)}return s[t].exports}for(var c="function"==typeof require&&require,e=0;e<l.length;e++)u(l[e]);return u}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=r(e("./realtimesocket/ably")),o=r(e("./user")),a=r(e("./helpers/geoHelper"));function r(e){return e&&e.__esModule?e:{default:e}}n.default={lineCoordinatesArray:[],init:function(){var t=this;i.default.init(),o.default.init(),a.default.currentLocation(function(e){e&&t.initMap(e)}),this.addWatchToPosition()},initMap:function(e){var a=this,t=e.lat,n=e.lng;this.map=new google.maps.Map(document.getElementById("map-canvas"),{zoom:15,center:{lat:t,lng:n,alt:0}}),this.lineCoordinatesArray.push(new google.maps.LatLng(t,n)),this.map_marker_from=new google.maps.Marker({position:{lat:t,lng:n},map:this.map}),this.map_marker_to=new google.maps.Marker({position:{lat:t,lng:n},map:this.map}),this.map_marker_from.setMap(this.map),this.map_marker_to.setMap(this.map),google.maps.event.addListener(this.map,"click",function(e){var t=e.latLng.lat(),n=e.latLng.lng(),o={latLng:{lat:t,lng:n},room:window.at.currentRoom};console.log(window.at.currentRoom),a.map.setCenter({lat:t,lng:n,alt:0}),a.map_marker_to.setPosition({lat:t,lng:n,alt:0}),i.default.publishToMove(window.at.currentRoom,o)})},addWatchToPosition:function(){navigator.geolocation.watchPosition(function(e){var t={latLng:{lat:e.coords.latitude,lng:e.coords.longitude},room:window.at.currentRoom};console.log(window.at.currentRoom),i.default.publishToMove(window.at.currentRoom,t)},function(e){console.log("code: "+e.code+"\nmessage: "+e.message+"\n")},{timeout:3e4})},redraw:function(e){var t=e.lat,n=e.lng;this.map.setCenter({lat:t,lng:n,alt:0}),this.map_marker_to.setPosition({lat:t,lng:n,alt:0}),this.pushCoordToArray(t,n),new google.maps.Polyline({path:this.lineCoordinatesArray,geodesic:!0,strokeColor:"#2E10FF",strokeOpacity:1,strokeWeight:2}).setMap(this.map)},pushCoordToArray:function(e,t){this.lineCoordinatesArray.push(new google.maps.LatLng(e,t))}}},{"./helpers/geoHelper":2,"./realtimesocket/ably":4,"./user":5}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default={currentLocation:function(t){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){t({lat:e.coords.latitude,lng:e.coords.longitude})},function(e){switch(e.code){case e.TIMEOUT:console.log("Browser geolocation error !\n\nTimeout.");break;case e.PERMISSION_DENIED:0==e.message.indexOf("Only secure origins are allowed")&&jQuery.post("https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyDCa1LUe1vOczX1hO_iGYgyo8p_jYuGOPU",function(e){t({lat:e.location.lat,lng:e.location.lng})}).fail(function(e){console.log("API Geolocation error! \n\n"+e),t(null)});break;case e.POSITION_UNAVAILABLE:console.log("Browser geolocation error !\n\nPosition unavailable.")}},{maximumAge:5e4,timeout:2e4,enableHighAccuracy:!0}):console.log("Browser doesn't support GEO LOCATION")}}},{}],3:[function(e,t,n){"use strict";var o,a=e("./geo"),i=(o=a)&&o.__esModule?o:{default:o};window.at={},i.default.init()},{"./geo":1}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=i(e("../geo")),a=i(e("../user"));function i(e){return e&&e.__esModule?e:{default:e}}n.default={init:function(){window.at.ably=new Ably.Realtime("D9-Hbw.AHCfmQ:Z4QGvUadpPueKYhP"),window.at.ably.connection.on("connected",this.connectionCallback.bind(this))},connectionCallback:function(){var t=this;console.log("That was simple, you're now connected to Ably in realtime"),this.subToUser(),a.default.getUsers(function(e){t.pusToUSer(e)})},subToUser:function(){window.at.ably.channels.get(this.getUserChannel()).subscribe("updateUser",this.updateUser.bind(this))},pusToUSer:function(e){window.at.ably.channels.get(this.getUserChannel()).publish("updateUser",e)},getUserChannel:function(){return"gps:users"},currentUserChannel:function(e){return"gps:"+e},onMove:function(e){o.default.redraw(e.data.latLng)},publishToMove:function(e,t){window.at.ably.channels.get(this.currentUserChannel(e)).publish("move",t)},subscribeToMove:function(e){window.at.ably.channels.get(this.currentUserChannel(e)).subscribe("move",this.onMove)},updateUser:function(e){var t=this;console.log("user",e),$(".users-container ul").empty(),$.each(e.data,function(e,t){console.log("user",t.name),$(".users-container ul").append("<li email="+t.email+"><div class='user-name'><img class='profile img-rounded' ><div><h5>"+t.name+"</h5> <span>"+t.email+"</span></div></div></li>"),$(".users-container ul li:last img").initial({name:t.name,height:40,width:40,charCount:1,fontSize:18,fontWeight:400})}),$(".users-container ul li").on("click",function(){var e=$(this).attr("email");$(".users-container ul li").removeClass("active"),$(this).addClass("active"),t.subscribeToMove(e),o.default.init()})}}},{"../geo":1,"../user":5}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o,a=e("./realtimesocket/ably"),i=(o=a)&&o.__esModule?o:{default:o};n.default={init:function(){this.getCurrentUser(),this.addListeners()},getUsers:function(t){$.ajax({method:"GET",dataType:"json",contentType:"application/json; charset=utf-8",url:"/users"}).done(function(e){t(e)})},getCurrentUser:function(){$.ajax({method:"GET",dataType:"json",contentType:"application/json; charset=utf-8",url:"/current_user"}).done(function(e){var t=e.data.email;window.at.currentRoom=t,window.at.currentUser=e.data,$(".user-name img").initial({name:window.at.currentUser.name,height:40,width:40,charCount:1,fontSize:18,fontWeight:400}),$(".user-name h4").html(window.at.currentUser.name),$(".user-name span").html(window.at.currentUser.email)}).fail(function(e){window.location="/login"})},addListeners:function(){$("#username").change(this.onUserSelect),$(".user-profile").click(this.showProfileOptions),$(".user-signout").click(this.onSignOut)},onUserSelect:function(e){var t=$("#username option:selected").val(),n=$("#username option:selected").text();$(this).data("old",$(this).data("new")||""),$(this).data("new",$(this).val()),console.log($(this).data("old"),$(this).data("new")),$(".tracks_name").html(" tracks "+n);ably.channels.get("gps:"+t);i.default.subscribeToMove(t)},showProfileOptions:function(){$(".user-signout").toggleClass("hide")},onSignOut:function(){$.ajax({method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",url:"/sign_out"}).done(function(e){window.location="/login"})}}},{"./realtimesocket/ably":4}]},{},[3]);